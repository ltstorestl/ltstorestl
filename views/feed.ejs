<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed</title>
  <link rel="stylesheet" href="/styles.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7249348633842889" crossorigin="anonymous"></script>
</head>
<body class="dark-theme">
  <div class="main-nav">
    <a href="/dashboard">Home</a>
    <a href="/feed">Feed</a>
    <a href="/inbox">Inbox</a>
    <a href="/settings">Settings</a>
    <a href="/logout">Logout</a>
  </div>
  <div class="feed-container">
    <h2>Feed</h2>
    <form class="feed-post-form" method="POST" action="/feed/post" enctype="multipart/form-data">
      <textarea name="content" placeholder="What's on your mind?" maxlength="300"></textarea>
      <input type="file" name="media" accept="image/*,image/gif">
      <select name="emoji" class="emoji-dropdown">
        <option value="">Add emoji...</option>
        <option value="😀">😀</option>
        <option value="😂">😂</option>
        <option value="😍">😍</option>
        <option value="😎">😎</option>
        <option value="🥳">🥳</option>
        <option value="😢">😢</option>
        <option value="🔥">🔥</option>
        <option value="👍">👍</option>
        <option value="🙏">🙏</option>
        <option value="🎉">🎉</option>
      </select>
      <button type="submit">Post</button>
    </form>
    <div class="feed-list">
      <% posts.forEach(function(post) { %>
        <div class="feed-post">
          <div class="feed-profile">
            <div style="position:relative;">
              <% if (post.profilePicture) { %>
                <img src="<%= post.profilePicture %>" class="profile-pic" alt="Profile Picture">
              <% } else { %>
                <span class="profile-pic placeholder"></span>
              <% } %>
              <% if (onlineUsers.some(u => u.username === post.author)) { %>
                <span class="online-dot"></span>
              <% } %>
            </div>
            <span><%= post.profileName %></span>
            <% if (user && (user.username === post.author || user.isAdmin)) { %>
              <form method="POST" action="/feed/delete" style="display:inline;margin-left:10px;">
                <input type="hidden" name="postId" value="<%= post._id %>">
                <button type="submit" class="delete-btn" style="color:#d32f2f;background:none;border:none;cursor:pointer;">Delete</button>
              </form>
            <% } %>
          </div>
          <div class="feed-content">
            <span style="font-size:1.4em;"><%= post.emoji %></span>
            <%= post.content %>
            <% if (post.media) { %>
              <img src="<%= post.media %>" class="feed-media" alt="media">
            <% } %>
            <div class="post-actions" style="margin-top:10px;display:flex;align-items:center;gap:16px;">
              <form method="POST" action="/feed/like" style="display:inline;">
                <input type="hidden" name="postId" value="<%= post._id %>">
                <button type="submit" class="like-btn" style="background:none;border:none;cursor:pointer;font-size:1.2em;">
                  👍 <span><%= post.likes || 0 %></span>
                </button>
              </form>
              <button type="button" class="comment-toggle-btn" onclick="toggleCommentBox('<%= post._id %>')" style="background:none;border:none;cursor:pointer;font-size:1.2em;">💬 Comment</button>
              <form method="POST" action="/feed/emoji" style="display:inline;">
                <input type="hidden" name="postId" value="<%= post._id %>">
                <select name="emoji" onchange="this.form.submit()" style="background:#23262f;color:#e3e6ed;border-radius:6px;padding:2px 6px;">
                  <option value="">😊</option>
                  <option value="😀">😀</option>
                  <option value="😂">😂</option>
                  <option value="😍">😍</option>
                  <option value="😎">😎</option>
                  <option value="🥳">🥳</option>
                  <option value="😢">😢</option>
                  <option value="🔥">🔥</option>
                  <option value="👍">👍</option>
                  <option value="🙏">🙏</option>
                  <option value="🎉">🎉</option>
                </select>
              </form>
            </div>
            <div class="comment-section" id="comment-section-<%= post._id %>" style="display:none;margin-top:10px;">
              <form method="POST" action="/feed/comment" style="display:flex;gap:8px;align-items:center;">
                <input type="hidden" name="postId" value="<%= post._id %>">
                <input type="text" name="comment" placeholder="Write a comment..." required style="flex:1;border-radius:6px;background:#23262f;color:#e3e6ed;border:1px solid #444857;padding:6px;">
                <button type="submit" style="background:#8ab4f8;color:#23262f;border:none;border-radius:6px;padding:6px 12px;">Post</button>
              </form>
              <div class="comments-list" style="margin-top:8px;">
                <% if (post.comments && post.comments.length) { %>
                  <% post.comments.forEach(function(c) { %>
                    <div class="comment-item" style="margin-bottom:6px;">
                      <span style="color:#8ab4f8;font-weight:500;"><%= c.user %>:</span>
                      <span><%= c.text %></span>
                    </div>
                  <% }) %>
                <% } %>
              </div>
            </div>
            <form method="POST" action="/feed/report" style="margin-top:8px;">
              <input type="hidden" name="postId" value="<%= post._id %>">
              <input type="hidden" name="reportedUser" value="<%= post.author %>">
              <select name="reason" required style="background:#23262f;color:#e3e6ed;border-radius:6px;padding:4px 8px;margin-right:8px;">
                <option value="">Report...</option>
                <option value="Spam">Spam</option>
                <option value="Harassment">Harassment</option>
                <option value="Inappropriate Content">Inappropriate Content</option>
                <option value="Other">Other</option>
              </select>
              <button type="submit" style="background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:4px 12px;">Report</button>
            </form>
          </div>
        </div>
      <% }) %>
      <% if (!posts.length) { %>
        <p style="color:#888;">No posts yet.</p>
      <% } %>
    </div>
    <!-- Floating chat box at bottom right -->
    <div class="feed-chatbox-with-avatars">
      <div class="feed-chatbox">
        <form id="chatForm" method="POST" action="/feed/message">
          <div class="feed-profile">
            <div style="position:relative;">
              <% if (user.profilePicture) { %>
                <img src="<%= user.profilePicture %>" class="profile-pic" alt="Profile Picture">
              <% } else { %>
                <span class="profile-pic placeholder"></span>
              <% } %>
              <% if (user.online) { %>
                <span class="online-dot"></span>
              <% } %>
            </div>
            <span><%= user.profileName || user.username %></span>
          </div>
          <div class="feed-content">
            <input type="hidden" name="to" id="chatToUser" required>
            <div id="chatRecipient" style="margin-bottom:10px;color:#8ab4f8;font-weight:500;"></div>
            <div id="chatMessages">
              <!-- Chat messages will be rendered here by JS -->
            </div>
            <textarea name="content" rows="2" placeholder="Type your message..." style="width:100%;border-radius:8px;background:#23262f;color:#e3e6ed;border:1px solid #444857;padding:8px;" required></textarea>
            <button type="submit" style="margin-top:8px;width:100%;">Send</button>
          </div>
        </form>
      </div>
      <div class="floating-chat-avatars">
        <% onlineUsers.forEach(function(u) { %>
          <span class="chat-avatar" data-username="<%= u.username %>" title="<%= u.profileName || u.username %>">
            <% if (u.profilePicture) { %>
              <img src="<%= u.profilePicture %>" class="profile-pic" alt="" />
            <% } else { %>
              <span class="profile-pic placeholder"></span>
            <% } %>
            <% if (u.online) { %>
              <span class="online-dot"></span>
            <% } %>
            <!-- No username, label, or span for name here -->
          </span>
        <% }) %>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Handle avatar click to set chat recipient
    document.querySelectorAll('.floating-chat-avatars .chat-avatar').forEach(function(avatar) {
      avatar.addEventListener('click', function() {
        var username = this.getAttribute('data-username');
        var displayName = this.getAttribute('title');
        document.getElementById('chatToUser').value = username;
        document.getElementById('chatRecipient').textContent = 'Chatting with: ' + displayName;
        document.querySelector('#chatForm textarea').focus();
        // Clear chat messages when switching recipient
        document.getElementById('chatMessages').innerHTML = '';
      });
    });
    // Prevent sending message if no recipient selected
    document.getElementById('chatForm').addEventListener('submit', function(e) {
      if (!document.getElementById('chatToUser').value) {
        alert('Please select a user to chat with by clicking their profile photo.');
        e.preventDefault();
        return;
      }
      e.preventDefault();
      const to = document.getElementById('chatToUser').value;
      const content = this.querySelector('textarea').value.trim();
      if (!content) return;
      // Send message via Socket.IO
      socket.emit('chat message', { from: '<%= user.username %>', to, content });
      this.querySelector('textarea').value = '';
    });
    function toggleCommentBox(postId) {
      var el = document.getElementById('comment-section-' + postId);
      if (el.style.display === 'none' || el.style.display === '') {
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }
    // Socket.IO client setup
    const socket = io();
    socket.emit('join', '<%= user.username %>');
    socket.on('chat message', function(msg) {
      // Only show messages for the current recipient
      const currentTo = document.getElementById('chatToUser').value;
      if (msg.from === '<%= user.username %>' && msg.to === currentTo ||
          msg.from === currentTo && msg.to === '<%= user.username %>') {
        const chatMessages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = 'chat-message-item';
        div.innerHTML = `<span class="from">${msg.from}:</span> <span>${msg.content}</span> <span class="timestamp">${new Date(msg.timestamp).toLocaleString()}</span>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    });
  </script>
</body>
</html>
